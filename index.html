<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotary District 1913 - Budget Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .hidden { display: none; }
        .rotary-gold { background-color: #F7A81B; }
        .rotary-gold-dark { background-color: #D89117; }
        .rotary-blue { background-color: #005DAA; }
        .rotary-blue-dark { background-color: #004280; }
        .text-rotary-gold { color: #F7A81B; }
        .text-rotary-blue { color: #005DAA; }
        .border-rotary-gold { border-color: #F7A81B; }
        .bg-rotary-gold-light { background-color: #FFF5E6; }
        
        /* Modern design improvements */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .card-modern {
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .card-modern:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        input, select, button {
            border-radius: 0.75rem !important;
        }
        
        .btn-modern {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .badge-modern {
            border-radius: 1rem;
            padding: 0.375rem 0.875rem;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        table thead th {
            background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
            border-bottom: 2px solid #e5e7eb;
        }
        
        table tbody tr {
            transition: all 0.2s ease;
        }
        
        table tbody tr:hover {
            background-color: #f9fafb;
            transform: scale(1.005);
        }
        
        .nav-tab {
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s ease;
        }
        
        .shadow-soft {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .gradient-header {
            background: linear-gradient(135deg, #005DAA 0%, #003d73 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-yellow-500 mx-auto mb-4"></div>
            <p class="text-rotary-blue font-semibold text-lg">Uƒçitavanje podataka...</p>
            <p class="text-gray-500 text-sm mt-1">Spajanje na Supabase bazu</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <!-- Rotary Logo -->
                <div class="mb-6">
                    <img src="https://rotary.hr/sites/all/themes/rotaryhr/rotaryhrlogo4.png" alt="Rotary District 1913" class="mx-auto drop-shadow-lg" style="height: 100px;">
                </div>
                <h1 class="text-3xl font-bold text-rotary-blue">Rotary District 1913</h1>
                <p class="text-gray-600 mt-2">Sustav za praƒáenje bud≈æeta</p>
                <p class="text-sm text-gray-500 mt-4">Razdoblje: 1.7.2026 - 30.6.2027</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                        type="email"
                        id="login-email"
                        class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                        placeholder="korisnik@rotary1913.org"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lozinka</label>
                    <input
                        type="password"
                        id="login-password"
                        class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                        required
                    />
                </div>
                
                <button
                    type="submit"
                    class="w-full rotary-gold hover:rotary-gold-dark text-white py-3 rounded-2xl transition-colors font-semibold shadow-lg"
                >
                    Prijava
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <!-- Header -->
        <header class="gradient-header text-white shadow-xl">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <!-- Official Rotary Logo -->
                        <img src="https://rotary.hr/sites/all/themes/rotaryhr/rotaryhrlogo4.png" alt="Rotary District 1913" style="height: 50px;">
                        <div>
                            <h1 class="text-2xl font-bold">Rotary District 1913</h1>
                            <p class="text-yellow-300 text-sm">Bud≈æet 2026/2027</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-sm text-yellow-200">Prijavljen kao</p>
                            <p class="font-semibold" id="user-name"></p>
                            <p class="text-xs text-yellow-300 capitalize" id="user-role"></p>
                        </div>
                        <button
                            id="logout-btn"
                            class="bg-blue-800 hover:bg-blue-900 px-5 py-3 rounded-2xl transition-colors"
                        >
                            Odjava
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-soft border-b-0">
            <div class="container mx-auto px-4">
                <div class="flex gap-2" id="nav-tabs">
                    <button data-tab="dashboard" class="nav-tab px-6 py-3 font-medium transition-colors border-b-4 border-rotary-gold text-rotary-gold">
                        Dashboard
                    </button>
                    <button data-tab="prihodi-klubovi" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="prihodi-klubovi-tab">
                        üí∞ Prihod po klubu
                    </button>
                    <button data-tab="prihodi" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="prihodi-tab">
                        Prihodi
                    </button>
                    <button data-tab="budget" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="budget-tab">
                        Bud≈æet
                    </button>
                    <button data-tab="upload" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="upload-tab">
                        Upload XLS/CSV
                    </button>
                    <button data-tab="realizirano" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="realizirano-tab">
                        Realizirano
                    </button>
                    <button data-tab="transactions" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold">
                        Transakcije
                    </button>
                    <button data-tab="users" class="nav-tab px-6 py-3 font-medium transition-colors text-gray-600 hover:text-rotary-gold hidden" id="users-tab">
                        Korisnici
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <div class="space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="card-modern bg-white p-6 border-l-4 border-green-500">
                            <p class="text-sm text-gray-600 font-medium">Prihodi (Bud≈æet)</p>
                            <p class="text-2xl font-bold text-green-600 mt-2" id="income-budget-total">‚Ç¨0</p>
                        </div>
                        <div class="card-modern bg-white p-6 border-l-4 border-green-600">
                            <p class="text-sm text-gray-600 font-medium">Prihodi (Realizirano)</p>
                            <p class="text-2xl font-bold text-green-700 mt-2" id="income-actual-total">‚Ç¨0</p>
                        </div>
                        <div class="card-modern bg-white p-6 border-l-4 border-red-500">
                            <p class="text-sm text-gray-600 font-medium">Rashodi (Bud≈æet)</p>
                            <p class="text-2xl font-bold text-red-600 mt-2" id="expense-budget-total">‚Ç¨0</p>
                        </div>
                        <div class="card-modern bg-white p-6 border-l-4 border-red-600">
                            <p class="text-sm text-gray-600 font-medium">Rashodi (Realizirano)</p>
                            <p class="text-2xl font-bold text-red-700 mt-2" id="expense-actual-total">‚Ç¨0</p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column - Bar Chart -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-0 border-rotary-gold">
                            <h3 class="text-lg font-semibold mb-4 text-rotary-blue">Bud≈æet vs Realizacija</h3>
                            <canvas id="comparison-chart"></canvas>
                        </div>

                        <!-- Right Column - Pie Charts -->
                        <div class="space-y-6">
                            <!-- Income Pie Chart -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-0 border-rotary-gold">
                                <h3 class="text-lg font-semibold mb-4 text-rotary-blue">Realizirani prihodi</h3>
                                <canvas id="income-pie-chart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Expense Pie Chart -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-0 border-rotary-gold">
                                <h3 class="text-lg font-semibold mb-4 text-rotary-blue">Realizirani rashodi</h3>
                                <canvas id="expense-pie-chart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Breakdown -->
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-0 border-rotary-gold">
                        <h3 class="text-lg font-semibold p-6 border-b bg-rotary-gold-light text-rotary-blue">Mjeseƒçni pregled po kategorijama</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="monthly-breakdown-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50">Kategorija</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-rotary-blue uppercase">UKUPNO</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">LIP</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">SRP</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">KOL</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">RUJ</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">LIS</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">STU</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">PRO</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">SIJ</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">VEL</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">O≈ΩU</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">TRA</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">SVI</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-breakdown-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prihod po klubu Tab -->
            <div id="tab-prihodi-klubovi" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- ƒålanarine -->
                    <div class="bg-white rounded-lg shadow-md border-t-4 border-rotary-gold p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-rotary-blue">üìã ƒålanarine</h2>
                            <button id="add-club-btn" class="rotary-gold text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90">+ Dodaj klub</button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-l-4 border-blue-600">
                                <p class="text-sm text-gray-600">Rotary ƒçlan</p>
                                <p class="text-3xl font-bold text-blue-600">‚Ç¨50</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-l-4 border-purple-600">
                                <p class="text-sm text-gray-600">Rotary supru≈ænik</p>
                                <p class="text-3xl font-bold text-purple-600">‚Ç¨30</p>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border-l-4 border-yellow-600">
                                <p class="text-sm text-gray-600">Rotaract ƒçlan</p>
                                <p class="text-3xl font-bold text-yellow-600">‚Ç¨25</p>
                            </div>
                        </div>

                        <div class="bg-rotary-gold-light p-6 rounded-lg mb-6 border-2 border-yellow-400">
                            <h3 class="font-bold mb-4 text-rotary-blue">üìä Ukupno - Svi klubovi</h3>
                            <div class="grid grid-cols-5 gap-4">
                                <div><p class="text-xs text-gray-600">Rotary ƒçlanovi</p><p class="text-2xl font-bold text-blue-600" id="total-rotary">0</p></div>
                                <div><p class="text-xs text-gray-600">Supru≈ænici</p><p class="text-2xl font-bold text-purple-600" id="total-spouses">0</p></div>
                                <div><p class="text-xs text-gray-600">Rotaract</p><p class="text-2xl font-bold text-yellow-600" id="total-rotaract">0</p></div>
                                <div><p class="text-xs text-gray-600">Planirano</p><p class="text-2xl font-bold text-green-600" id="total-planned">‚Ç¨0</p></div>
                                <div><p class="text-xs text-gray-600">Uplaƒáeno</p><p class="text-2xl font-bold text-green-700" id="total-actual">‚Ç¨0</p></div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold uppercase">Klub</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">Rotary</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">Supru≈ænici</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">Rotaract</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold uppercase">Planirano ‚Ç¨</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold uppercase">Uplaƒáeno ‚Ç¨</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold uppercase">Preostalo ‚Ç¨</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">‚ùå</th>
                                    </tr>
                                </thead>
                                <tbody id="clubs-tbody"></tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button id="save-clubs" class="rotary-gold text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 shadow-md">üíæ Spremi ƒçlanarine</button>
                        </div>
                    </div>

                    <!-- Ostali prihodi -->
                    <div class="bg-white rounded-lg shadow-md border-t-4 border-rotary-gold p-6">
                        <h2 class="text-xl font-bold text-rotary-blue mb-6">üí∞ Ostali prihodi</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="other-income"></div>
                        <div class="mt-6 flex justify-end">
                            <button id="save-other" class="rotary-gold text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 shadow-md">üíæ Spremi ostale prihode</button>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="bg-white rounded-lg shadow-md border-t-4 border-rotary-gold p-6">
                        <h2 class="text-xl font-bold text-rotary-blue mb-6">üìã Log aktivnosti</h2>
                        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto" id="prihodi-activity-log">
                            <p class="text-sm text-gray-500 italic text-center py-8">Jo≈° nema zabilje≈æenih promjena...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="tab-budget" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-0 border-rotary-gold">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-rotary-blue">Postavljanje godi≈°njeg bud≈æeta</h2>
                        <button id="save-budget-btn" class="rotary-gold hover:rotary-gold-dark text-white px-6 py-2 rounded-2xl transition-colors font-semibold shadow-lg">
                            üíæ Spremi promjene
                        </button>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-green-700">Prihodi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="income-budget-inputs"></div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-red-700">Rashodi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="expense-budget-inputs"></div>
                    </div>

                    <!-- Activity Log -->
                    <div class="mt-8 border-t-2 border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold mb-4 text-rotary-blue">üìã Log aktivnosti</h3>
                        <div class="bg-gray-50 rounded-2xl p-4 max-h-64 overflow-y-auto" id="budget-activity-log">
                            <p class="text-sm text-gray-500 italic">Jo≈° nema zabilje≈æenih promjena...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload CSV Tab -->
            <div id="tab-upload" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-0 border-rotary-gold">
                    <h2 class="text-xl font-semibold mb-6 text-rotary-blue">üìÇ Upload bankovnog izvoda (XLS/CSV)</h2>
                    
                    <div class="border-2 border-dashed border-rotary-gold rounded-2xl p-12 text-center bg-rotary-gold-light">
                        <svg class="mx-auto mb-4 text-rotary-gold" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        <p class="text-gray-600 mb-2 font-medium">Kliknite za odabir datoteke</p>
                        <p class="text-sm text-gray-500 mb-4">Podr≈æani formati: <strong>.xls, .xlsx, .csv</strong></p>
                        <input type="file" accept=".csv,.xls,.xlsx" id="csv-upload" class="hidden" />
                        <label for="csv-upload" class="inline-block rotary-gold hover:rotary-gold-dark text-white px-6 py-3 rounded-2xl cursor-pointer transition-colors font-semibold shadow-lg">
                            üìÅ Odaberi datoteku
                        </label>
                    </div>

                    <!-- Upload progress -->
                    <div id="upload-progress" class="hidden mt-6 p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                            <span id="upload-progress-text" class="text-blue-700 font-medium">Obraƒëujem datoteku...</span>
                        </div>
                    </div>

                    <!-- Upload results -->
                    <div id="upload-results" class="hidden mt-6">
                        <div class="p-4 bg-green-50 rounded-2xl border border-green-200 mb-4">
                            <p id="upload-summary" class="font-semibold text-green-800"></p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="px-4 py-2 text-left">Datum</th>
                                        <th class="px-4 py-2 text-left">Korisnik</th>
                                        <th class="px-4 py-2 text-left">Opis</th>
                                        <th class="px-4 py-2 text-right">Iznos</th>
                                        <th class="px-4 py-2 text-center">Tip</th>
                                        <th class="px-4 py-2 text-left">Kategorija</th>
                                        <th class="px-4 py-2 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="upload-preview-tbody"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-3">
                            <button id="confirm-upload-btn" class="rotary-gold text-white px-6 py-3 rounded-2xl font-semibold shadow-lg">
                                ‚úÖ Spremi transakcije
                            </button>
                            <button id="cancel-upload-btn" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-2xl font-semibold">
                                ‚úï Odustani
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <h4 class="font-semibold mb-2 text-rotary-blue">Format HPB izvoda:</h4>
                        <p class="text-sm text-gray-700">Aplikacija automatski ƒçita HPB format:</p>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-600">
                            <div>üìÖ <strong>Stupac A</strong> - Datum</div>
                            <div>üë§ <strong>Stupac C</strong> - Korisnik</div>
                            <div>üìù <strong>Stupac D</strong> - Opis</div>
                            <div>üí∏ <strong>Stupac E</strong> - Isplate (tro≈°kovi)</div>
                            <div>üí∞ <strong>Stupac F</strong> - Uplate (prihodi)</div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è Veƒá uvezene transakcije neƒáe biti duplicirane</p>
                    </div>
                </div>
            </div>

            <!-- Realizirano Tab -->
            <div id="tab-realizirano" class="tab-content hidden">
                <!-- Manual Entry Form -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-rotary-gold mb-6">
                    <h2 class="text-xl font-semibold text-rotary-blue mb-4">‚ûï Ruƒçni unos prihoda/tro≈°ka</h2>
                    <form id="manual-entry-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                            <input type="date" id="manual-date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-rotary-gold" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tip</label>
                            <select id="manual-type" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-rotary-gold">
                                <option value="">Odaberi...</option>
                                <option value="income">Prihod</option>
                                <option value="expense">Tro≈°ak</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategorija</label>
                            <select id="manual-category" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-rotary-gold">
                                <option value="">Odaberi tip prvo...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Iznos (‚Ç¨)</label>
                            <input type="number" id="manual-amount" step="0.01" min="0" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-rotary-gold" />
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full rotary-gold text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 shadow-md">
                                üíæ Dodaj
                            </button>
                        </div>
                    </form>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Opis (opcionalno)</label>
                        <input type="text" id="manual-description" placeholder="Unesite opis transakcije..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-rotary-gold" />
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="tab-transactions" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-0 border-rotary-gold mb-6">
                    <div class="p-6 border-b bg-rotary-gold-light flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-semibold text-rotary-blue">Sve transakcije</h2>
                            <p class="text-gray-600 text-sm mt-1">Ukupno: <span id="transaction-count">0</span> transakcija</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="save-transactions-btn" class="hidden rotary-gold text-white px-5 py-2 rounded-2xl font-semibold shadow-lg edit-column">
                                üíæ Spremi promjene
                            </button>
                            <button id="delete-all-transactions-btn" class="hidden bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-2xl font-semibold shadow-lg edit-column">
                                üóëÔ∏è Obri≈°i sve
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mjesec</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opis</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tip</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategorija</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Klub</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Iznos</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Izvor</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase edit-column">Akcije</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Transactions Activity Log -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-rotary-gold">
                    <h2 class="text-xl font-semibold text-rotary-blue mb-4">üìã Log promjena transakcija</h2>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto" id="transactions-activity-log">
                        <p class="text-sm text-gray-500 italic text-center py-8">Jo≈° nema promjena...</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg border-t-0 border-rotary-gold">
                    <div class="p-6 border-b bg-rotary-gold-light flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-semibold text-rotary-blue">Upravljanje korisnicima</h2>
                            <p class="text-gray-600 text-sm mt-1">Ukupno: <span id="users-count">0</span> korisnika</p>
                        </div>
                        <button id="add-user-btn" class="rotary-gold hover:rotary-gold-dark text-white px-5 py-3 rounded-2xl transition-colors font-semibold shadow-lg">
                            + Dodaj korisnika
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ime</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Uloga</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pristup</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Akcije</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>

                    <!-- Role Legend -->
                    <div class="p-6 border-t bg-gray-50">
                        <h4 class="font-semibold mb-3 text-sm text-gray-700">Razine pristupa:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="px-3 py-1 text-xs rounded-full font-semibold bg-yellow-100 text-yellow-800">Admin</span>
                                <p class="text-gray-600">Puni pristup - sve funkcije, upravljanje korisnicima</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="px-3 py-1 text-xs rounded-full font-semibold bg-blue-100 text-blue-800">Editor</span>
                                <p class="text-gray-600">Mo≈æe ureƒëivati bud≈æet, uploadati CSV, kategorizirati</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="px-3 py-1 text-xs rounded-full font-semibold bg-gray-100 text-gray-800">Viewer</span>
                                <p class="text-gray-600">Samo pregled - Dashboard i Bud≈æet (read-only)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="rotary-blue text-white mt-12 py-6">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center">
                    <p class="text-sm text-yellow-200">¬© 2026 Rotary District 1913 Croatia | Sustav za praƒáenje bud≈æeta</p>
                    <button id="export-data-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg transition-colors font-semibold shadow-md flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        Export podataka (CSV)
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add User Modal -->
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md border-t-0 border-rotary-gold">
            <h3 class="text-lg font-semibold mb-4 text-rotary-blue">Dodaj novog korisnika</h3>
            
            <form id="add-user-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ime i prezime</label>
                    <input type="text" id="new-user-name" class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500" required />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email adresa</label>
                    <input type="email" id="new-user-email" class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500" required />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lozinka</label>
                    <input type="password" id="new-user-password" class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500" required />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Uloga korisnika</label>
                    <select id="new-user-role" class="w-full px-5 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500">
                        <option value="viewer">Viewer - samo pregled (Dashboard, Bud≈æet)</option>
                        <option value="editor">Editor - mo≈æe ureƒëivati i uploadati</option>
                        <option value="admin">Admin - puni pristup + upravljanje korisnicima</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1" id="role-description">
                        Viewer mo≈æe samo pregledavati Dashboard i Bud≈æet bez moguƒánosti ureƒëivanja.
                    </p>
                </div>

                <div class="flex gap-2 mt-6">
                    <button type="submit" class="flex-1 rotary-gold hover:rotary-gold-dark text-white py-2 rounded-2xl font-semibold">
                        Dodaj korisnika
                    </button>
                    <button type="button" id="cancel-user-btn" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-2xl hover:bg-gray-300">
                        Odustani
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data
        const INCOME_CATEGORIES = [
            'Prihodi od ƒçlanarina',
            'Prihodi od donacija RI za pokriƒáe tro≈°kova DG',
            'Prihodi od kotizacija za YE, Rotary kamp, RYLA',
            'Prihodi od donacija',
            'Prihodi od kamata na depozite poviƒëenju',
            'Ostali prihodi',
            'Sredstva iz vi≈°ka sredstava prethodnih godina'
        ];
        const EXPENSE_CATEGORIES = [
            'Predsjedni≈°tvo Distrikta',
            'DG - Distrikt guverner',
            'DGE - Guverner elect',
            'DGN - Guverner nominee',
            'Tajni≈°tvo Distrikta',
            'Opƒái tro≈°kovi Distrikta',
            'Odbor za razvoj ƒçlanstva(& prisirenje)',
            'Odbor za organizaciju Distriktne konferencije',
            'Odbor za Youth exchange',
            'Odbor za Interact',
            'Odbor za Rotaract',
            'Odbor za RYLA',
            'Odbor za Rotary zakladu',
            'Odbor za odnose s javno≈°ƒáu',
            'Odbor za Rotary Fellowship',
            'Odbor za obuku',
            'Odbor za financije',
            'Odbor za promicanje RI konvencije',
            'Odbor za Alumni',
            'Odbor za slu≈æenje zajednici',
            'Odbor za slu≈æenje zvanju',
            'Odbor za razmjenu prijateljstva RFE',
            'Odbor za ICC',
            'Paul Harris Society',
            'Obilje≈æavanje godi≈°njice Distrikta',
            'Odbor za Pravna pitanja',
            'Odbor za meƒëunarodno slu≈æenje',
            'Odbor za slu≈æenje mladima'
        ];
        
        // ==========================================
        // SUPABASE CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://zcaxsprhauscpfmlgzdi.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_BHrhNESd3vZ_XzLH69dHWg_z1y1fskp';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==========================================
        // DATA VARIABLES
        // ==========================================
        let currentUser = null;
        let budgetData = {
            income: Object.fromEntries(INCOME_CATEGORIES.map(cat => [cat, 0])),
            expenses: Object.fromEntries(EXPENSE_CATEGORIES.map(cat => [cat, 0]))
        };
        let transactions = [];
        let users = [];
        let charts = {};
        let activityLog = [];
        let pendingBudgetChanges = {};

        let clubsData = {};
        let otherIncomeData = {
            'Prihodi od donacija RI za pokriƒáe tro≈°kova DG': { planned: 0, actual: 0 },
            'Prihodi od kotizacija za YE, Rotary kamp, RYLA': { planned: 0, actual: 0 },
            'Prihodi od donacija': { planned: 0, actual: 0 },
            'Prihodi od kamata na depozite poviƒëenju': { planned: 0, actual: 0 },
            'Ostali prihodi': { planned: 0, actual: 0 },
            'Sredstva iz vi≈°ka sredstava prethodnih godina': { planned: 0, actual: 0 }
        };
        let prihodiLog = [];
        let manualEntryLog = [];

        // ==========================================
        // LOADING HELPER
        // ==========================================
        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if (el) el.classList.toggle('hidden', !show);
        }

        // ==========================================
        // LOAD ALL DATA FROM SUPABASE
        // ==========================================
        async function loadData() {
            showLoading(true);
            try {
                // 1. Budget
                const { data: budgetRows } = await sb.from('budget').select('*');
                if (budgetRows && budgetRows.length > 0) {
                    budgetRows.forEach(row => {
                        if (row.type === 'income') budgetData.income[row.category] = parseFloat(row.amount) || 0;
                        else budgetData.expenses[row.category] = parseFloat(row.amount) || 0;
                    });
                }

                // 2. Transactions
                const { data: transRows } = await sb.from('transactions').select('*').order('created_at', { ascending: false });
                if (transRows) {
                    console.log('üì• Raw transaction from DB (first one):', transRows[0]);
                    transactions = transRows.map(t => ({
                        id: t.id,
                        date: t.date,
                        description: t.description || '',
                        type: t.type,
                        category: t.category || '',
                        amount: parseFloat(t.amount),
                        source: t.source || 'manual',
                        club_name: t.club_name || null
                    }));
                    console.log('üì§ Mapped transaction (first one):', transactions[0]);
                }

                // 3. Users
                const { data: userRows } = await sb.from('users').select('*');
                if (userRows) users = userRows;

                // 4. Activity log
                const { data: logRows } = await sb.from('activity_logs').select('*').order('created_at', { ascending: false }).limit(100);
                if (logRows) activityLog = logRows.map(l => ({
                    timestamp: new Date(l.created_at).toLocaleString('hr-HR'),
                    user: l.user_name || 'System',
                    action: l.description,
                    type: l.log_type
                }));

                // 5. Clubs
                const { data: clubRows } = await sb.from('clubs').select('*');
                if (clubRows) {
                    clubsData = {};
                    clubRows.forEach(c => {
                        clubsData[c.name] = {
                            rotaryMembers: c.rotary_members || 0,
                            spouses: c.spouses || 0,
                            rotaractMembers: c.rotaract_members || 0,
                            actualPayment: parseFloat(c.actual_payment) || 0
                        };
                    });
                }

                // 6. Other income
                const { data: otherRows } = await sb.from('other_income').select('*');
                if (otherRows) {
                    otherRows.forEach(o => {
                        if (otherIncomeData[o.category] !== undefined) {
                            otherIncomeData[o.category] = {
                                planned: parseFloat(o.planned) || 0,
                                actual: parseFloat(o.actual) || 0
                            };
                        }
                    });
                }

                // 7. Manual entry log
                const { data: manualRows } = await sb.from('activity_logs').select('*').eq('log_type', 'manual_entry').order('created_at', { ascending: false }).limit(100);
                if (manualRows) {
                    manualEntryLog = manualRows.map(r => {
                        try { return JSON.parse(r.new_value); } catch(e) { return null; }
                    }).filter(Boolean);
                }

                // 8. Prihodi log
                const { data: prihodiRows } = await sb.from('activity_logs').select('*').in('log_type', ['club_change', 'income_change', 'club_added', 'club_deleted']).order('created_at', { ascending: false }).limit(100);
                if (prihodiRows) {
                    prihodiLog = prihodiRows.map(r => ({
                        timestamp: new Date(r.created_at).toLocaleString('hr-HR'),
                        user: r.user_name || 'System',
                        type: r.log_type,
                        description: r.description,
                        oldValue: r.old_value,
                        newValue: r.new_value
                    }));
                }

                // Sync budget from clubs
                updateMainBudgetFromClubs();

                console.log('‚úÖ Data loaded from Supabase');
                console.log('üìä Loaded clubs:', Object.keys(clubsData).length, clubsData);
                console.log('üí∞ Loaded transactions:', transactions.length);
            } catch (err) {
                console.error('‚ùå Error loading data:', err);
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // SAVE DATA TO SUPABASE
        // ==========================================
        async function saveData(key, data) {
            try {
                if (key === 'rotary-budget') {
                    const rows = [
                        ...INCOME_CATEGORIES.map(cat => ({ category: cat, type: 'income', amount: data.income[cat] || 0, fiscal_year: '2026-2027' })),
                        ...EXPENSE_CATEGORIES.map(cat => ({ category: cat, type: 'expense', amount: data.expenses[cat] || 0, fiscal_year: '2026-2027' }))
                    ];
                    await sb.from('budget').upsert(rows, { onConflict: 'category,type,fiscal_year' });

                } else if (key === 'rotary-transactions') {
                    for (const t of data) {
                        await sb.from('transactions').upsert({
                            id: t.id,
                            date: t.date,
                            description: t.description,
                            type: t.type,
                            category: t.category,
                            amount: t.amount,
                            source: t.source || 'manual'
                        });
                    }

                } else if (key === 'rotary-users') {
                    for (const u of data) {
                        await sb.from('users').upsert({
                            id: u.id,
                            email: u.email,
                            name: u.name,
                            role: u.role,
                            password_hash: u.password_hash || u.password
                        });
                    }
                }
            } catch (err) {
                console.error('‚ùå saveData error for', key, err);
            }
        }

        async function logActivity(type, description, oldVal = null, newVal = null) {
            try {
                await sb.from('activity_logs').insert({
                    log_type: type,
                    description: description,
                    old_value: oldVal !== null ? String(oldVal) : null,
                    new_value: newVal !== null ? String(newVal) : null,
                    user_name: currentUser ? currentUser.name : 'System',
                    user_id: currentUser ? currentUser.id : null
                });
            } catch (err) {
                console.error('Log error:', err);
            }
        }

        // ==========================================
        // FIX 1: LOGIN - ispravljen error handling
        // ==========================================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            showLoading(true);

            // Dohvati korisnika iz baze
            const { data: userData, error } = await sb
                .from('users')
                .select('*')
                .eq('email', email)
                .eq('password_hash', password)
                .maybeSingle();

            if (error) {
                // Gre≈°ka u komunikaciji s bazom
                showLoading(false);
                alert('Gre≈°ka pri prijavi: ' + error.message);
                return; // STOP - ne nastavljaj dalje
            }

            if (!userData) {
                // Korisnik nije pronaƒëen ili pogre≈°na lozinka
                showLoading(false);
                alert('Neispravno korisniƒçko ime ili lozinka');
                return; // STOP - ne nastavljaj dalje
            }

            // Uspje≈°na prijava
            currentUser = userData;
            await loadData();
            showApp();
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        });

        // Show app
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = `(${currentUser.role})`;

            // Role-based tab visibility
            if (currentUser.role === 'admin') {
                document.getElementById('budget-tab').classList.remove('hidden');
                document.getElementById('upload-tab').classList.remove('hidden');
                document.getElementById('realizirano-tab').classList.remove('hidden');
                document.getElementById('prihodi-klubovi-tab').classList.remove('hidden');
                document.getElementById('users-tab').classList.remove('hidden');
                document.querySelectorAll('.edit-column').forEach(el => el.classList.remove('hidden'));
            } else if (currentUser.role === 'editor') {
                document.getElementById('budget-tab').classList.remove('hidden');
                document.getElementById('upload-tab').classList.remove('hidden');
                document.getElementById('realizirano-tab').classList.remove('hidden');
                document.getElementById('prihodi-klubovi-tab').classList.remove('hidden');
                document.getElementById('users-tab').classList.add('hidden');
                document.querySelectorAll('.edit-column').forEach(el => el.classList.remove('hidden'));
            } else if (currentUser.role === 'viewer') {
                document.getElementById('budget-tab').classList.remove('hidden');
                document.getElementById('upload-tab').classList.add('hidden');
                document.getElementById('realizirano-tab').classList.add('hidden');
                document.getElementById('prihodi-klubovi-tab').classList.add('hidden');
                document.getElementById('users-tab').classList.add('hidden');
                document.querySelectorAll('.edit-column').forEach(el => el.classList.add('hidden'));
                setTimeout(() => {
                    document.querySelectorAll('.budget-input').forEach(input => {
                        input.disabled = true;
                        input.classList.add('bg-gray-100', 'cursor-not-allowed');
                    });
                    const saveBtn = document.getElementById('save-budget-btn');
                    if (saveBtn) saveBtn.style.display = 'none';
                }, 100);
            }

            initBudgetInputs();
            renderDashboard();
            renderTransactions();

            renderUsers();
            renderActivityLog();
            renderClubs();
            renderOtherIncome();
            renderPrihodiLog();
            renderManualEntryLog();
            renderTransactionsLog();
            setupManualEntryForm();
        }

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('border-b-4', 'border-rotary-gold', 'text-rotary-gold');
                    t.classList.add('text-gray-600');
                });
                tab.classList.add('border-b-4', 'border-rotary-gold', 'text-rotary-gold');
                tab.classList.remove('text-gray-600');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                if (tabName === 'dashboard') renderDashboard();
                if (tabName === 'prihodi-klubovi') renderClubs();
                if (tabName === 'transactions') renderTransactions();
            });
        });

        // Init budget inputs
        function initBudgetInputs() {
            const incomeContainer = document.getElementById('income-budget-inputs');
            incomeContainer.innerHTML = '';
            INCOME_CATEGORIES.forEach(cat => {
                incomeContainer.innerHTML += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${cat}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500">‚Ç¨</span>
                            <input
                                type="number"
                                data-type="income"
                                data-category="${cat}"
                                value="${budgetData.income[cat] || ''}"
                                class="budget-input w-full pl-8 pr-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500"
                                placeholder="0"
                            />
                        </div>
                    </div>
                `;
            });

            const expenseContainer = document.getElementById('expense-budget-inputs');
            expenseContainer.innerHTML = '';
            EXPENSE_CATEGORIES.forEach(cat => {
                expenseContainer.innerHTML += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${cat}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500">‚Ç¨</span>
                            <input
                                type="number"
                                data-type="expenses"
                                data-category="${cat}"
                                value="${budgetData.expenses[cat] || ''}"
                                class="budget-input w-full pl-8 pr-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-yellow-500"
                                placeholder="0"
                            />
                        </div>
                    </div>
                `;
            });

            document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const type = e.target.dataset.type;
                    const category = e.target.dataset.category;
                    const value = parseFloat(e.target.value) || 0;
                    
                    // Track pending changes
                    if (!pendingBudgetChanges[type]) pendingBudgetChanges[type] = {};
                    pendingBudgetChanges[type][category] = {
                        old: budgetData[type][category],
                        new: value
                    };
                    
                    // Highlight save button
                    const saveBtn = document.getElementById('save-budget-btn');
                    saveBtn.classList.add('animate-pulse');
                    saveBtn.textContent = 'üíæ Spremi promjene *';
                });
            });
        }

        // Save budget changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('save-budget-btn').addEventListener('click', async () => {
                const changes = [];
                const timestamp = new Date().toLocaleString('hr-HR');

                for (const type in pendingBudgetChanges) {
                    for (const category in pendingBudgetChanges[type]) {
                        const change = pendingBudgetChanges[type][category];
                        budgetData[type][category] = change.new;
                        changes.push({
                            timestamp,
                            user: currentUser.name,
                            type: type === 'income' ? 'Prihod' : 'Rashod',
                            category,
                            oldValue: change.old,
                            newValue: change.new
                        });
                    }
                }

                if (changes.length > 0) {
                    showLoading(true);
                    activityLog = [...changes, ...activityLog];
                    await saveData('rotary-budget', budgetData);
                    
                    // Log all changes to Supabase
                    for (const ch of changes) {
                        await sb.from('activity_logs').insert({
                            log_type: 'budget_change',
                            description: `${ch.type} - ${ch.category}`,
                            old_value: String(ch.oldValue),
                            new_value: String(ch.newValue),
                            user_name: currentUser.name,
                            user_id: currentUser.id
                        });
                    }

                    pendingBudgetChanges = {};
                    showLoading(false);
                    
                    const saveBtn = document.getElementById('save-budget-btn');
                    saveBtn.classList.remove('animate-pulse');
                    saveBtn.textContent = '‚úÖ Spremljeno!';
                    setTimeout(() => { saveBtn.textContent = 'üíæ Spremi promjene'; }, 2000);
                    
                    renderActivityLog();
                    renderDashboard();
                    alert(`Spremljeno ${changes.length} promjena!`);
                }
            });
        });

        // Render Activity Log
        function renderActivityLog() {
            const logContainer = document.getElementById('budget-activity-log');
            if (!logContainer) return;
            
            if (activityLog.length === 0) {
                logContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Jo≈° nema zabilje≈æenih promjena...</p>';
                return;
            }

            logContainer.innerHTML = activityLog.slice(0, 20).map(log => `
                <div class="mb-3 p-3 bg-white rounded border-l-4 border-blue-400">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-800">${log.action || log.description || 'Promjena'}</p>
                            <p class="text-xs text-gray-500 mt-1">${log.type || log.log_type || ''}</p>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        ${log.user} ‚Ä¢ ${log.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // Render Realizirano
        function renderRealizirano() {
            const tbody = document.getElementById('realizirano-table-body');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">Nema uƒçitanih transakcija. Uploadajte CSV datoteku.</td></tr>';
                return;
            }

            transactions.forEach(trans => {
                const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.role === 'editor');
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">
                            ${canEdit ? `
                                <input type="text" value="${trans.date}" 
                                       data-id="${trans.id}" 
                                       class="realizirano-date-edit border rounded px-2 py-1 w-28 text-sm focus:ring-2 focus:ring-yellow-500"
                                       placeholder="DD.MM.YYYY" />
                            ` : trans.date}
                        </td>
                        <td class="px-6 py-4 text-sm">${trans.description}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${trans.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${trans.type === 'income' ? 'Prihod' : 'Rashod'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${canEdit ? `
                                <select data-id="${trans.id}" class="realizirano-category-select border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-yellow-500">
                                    <option value="">Odaberi kategoriju...</option>
                                    ${(trans.type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES).map(cat => 
                                        `<option value="${cat}" ${cat === trans.category ? 'selected' : ''}>${cat}</option>`
                                    ).join('')}
                                </select>
                            ` : (trans.category || '‚Äî')}
                        </td>
                        <td class="px-6 py-4 text-right font-medium ${trans.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ‚Ç¨${Math.abs(trans.amount).toLocaleString()}
                        </td>
                    </tr>
                `;
            });

            // Date edit handler for Realizirano tab
            document.querySelectorAll('.realizirano-date-edit').forEach(input => {
                input.addEventListener('blur', async (e) => {
                    const id = e.target.dataset.id;
                    const newDate = e.target.value.trim();
                    const trans = transactions.find(t => t.id == id);
                    if (trans && newDate) {
                        const datePattern = /^\d{1,2}\.\d{1,2}\.\d{4}$/;
                        if (datePattern.test(newDate)) {
                            trans.date = newDate;
                            await sb.from('transactions').update({ date: newDate }).eq('id', trans.id);
                            renderDashboard();
                            renderTransactions();
                        } else {
                            alert('Neispravan format datuma! Koristite: DD.MM.YYYY');
                            e.target.value = trans.date;
                        }
                    }
                });
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') e.target.blur();
                });
            });

            // Add event listeners for category changes
            document.querySelectorAll('.realizirano-category-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const id = e.target.dataset.id;
                    const trans = transactions.find(t => t.id == id);
                    if (trans) {
                        trans.category = e.target.value;
                        await sb.from('transactions').update({ category: e.target.value }).eq('id', trans.id);
                        renderDashboard();
                        renderTransactions();
                    }
                });
            });
        }

        // XLS/CSV Upload - HPB format
        let pendingUploadTransactions = [];

        // Helper: parse Excel date serial to DD.MM.YYYY
        function excelDateToString(serial) {
            if (!serial) return '';
            
            // Ako je veƒá string
            if (typeof serial === 'string') {
                const trimmed = serial.trim();
                console.log('üìÖ String datum iz Excel-a:', trimmed);
                
                // Provjeri da li je u DD.MM.YYYY formatu
                if (trimmed.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
                    return trimmed; // Veƒá je u dobrom formatu
                }
                
                // Ako je u nekom drugom formatu, poku≈°aj parsirati
                return trimmed;
            }
            
            // Ako je Excel serial broj (broj dana od 1.1.1900)
            if (typeof serial === 'number') {
                const utc_days = Math.floor(serial - 25569);
                const utc_value = utc_days * 86400;
                const date = new Date(utc_value * 1000);
                const d = String(date.getUTCDate()).padStart(2, '0');
                const m = String(date.getUTCMonth() + 1).padStart(2, '0');
                const y = date.getUTCFullYear();
                const result = `${d}.${m}.${y}`;
                console.log('üìÖ Serial datum iz Excel-a:', serial, '‚Üí', result);
                return result;
            }
            
            // Ako je JavaScript Date objekt (≈°to Excel parser ponekad vraƒáa)
            if (serial instanceof Date) {
                const d = String(serial.getDate()).padStart(2, '0');
                const m = String(serial.getMonth() + 1).padStart(2, '0');
                const y = serial.getFullYear();
                const result = `${d}.${m}.${y}`;
                console.log('üìÖ Date objekt iz Excel-a:', serial, '‚Üí', result);
                return result;
            }
            
            console.log('‚ö†Ô∏è Nepoznati format datuma:', serial, typeof serial);
            return '';
        }

        // Helper: extract month label from DD.MM.YYYY
        function dateToMonth(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('.');
            if (parts.length < 2) return dateStr;
            const months = ['SIJ','VEL','O≈ΩU','TRA','SVI','LIP','SRP','KOL','RUJ','LIS','STU','PRO'];
            const m = parseInt(parts[1]) - 1;
            return months[m] || dateStr;
        }

        document.getElementById('csv-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progress = document.getElementById('upload-progress');
            const progressText = document.getElementById('upload-progress-text');
            const results = document.getElementById('upload-results');

            progress.classList.remove('hidden');
            results.classList.add('hidden');
            progressText.textContent = 'ƒåitam datoteku...';

            try {
                console.log('üîµ 1. ƒåitam arrayBuffer...');
                const arrayBuffer = await file.arrayBuffer();
                
                console.log('üîµ 2. Parsiram XLSX...');
                // VA≈ΩNO: cellDates: false i raw: false sprjeƒçavaju automatsku konverziju datuma
                const workbook = XLSX.read(arrayBuffer, { 
                    type: 'array', 
                    cellDates: false,
                    raw: false  // Ne pretvori datume u brojeve
                });
                
                console.log('üîµ 3. Dohvaƒáam sheet...');
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                console.log('üîµ 4. Decode range...');
                // Naƒëi range
                const range = XLSX.utils.decode_range(sheet['!ref']);
                
                console.log('üîµ 5. Range decoded:', range);
                progressText.textContent = `Pronaƒëeno ${range.e.r + 1} redaka. Filtriram transakcije...`;

                const newTransactions = [];
                const skippedDuplicates = [];
                let skippedNoCellA = 0;
                let skippedNoAmount = 0;
                let skippedBadDate = 0;

                console.log('üîµ 6. Pocinjem iteraciju kroz redove...');
                // Iteriraj kroz sve redove
                for (let rowNum = range.s.r; rowNum <= range.e.r; rowNum++) {
                    // ƒåitaj raw vrijednosti iz ƒáelija
                    const cellA = sheet[XLSX.utils.encode_cell({ r: rowNum, c: 0 })]; // Datum
                    const cellC = sheet[XLSX.utils.encode_cell({ r: rowNum, c: 2 })]; // User
                    const cellD = sheet[XLSX.utils.encode_cell({ r: rowNum, c: 3 })]; // Description
                    const cellE = sheet[XLSX.utils.encode_cell({ r: rowNum, c: 4 })]; // Expense
                    const cellF = sheet[XLSX.utils.encode_cell({ r: rowNum, c: 5 })]; // Income

                    if (!cellA) {
                        skippedNoCellA++;
                        continue;
                    }

                    // KRITIƒåNO: Uvijek ƒçitaj .w (formatted text) prvo, pa tek onda .v
                    let rawDate = cellA.w || cellA.v;
                    
                    // Ako je JavaScript Date objekt (≈°to se de≈°ava kod CSV-a), NE koristi ga - veƒá poku≈°aj iz .w
                    if (rawDate instanceof Date) {
                        rawDate = cellA.w || null;
                    }
                    
                    const user = cellC ? String(cellC.v || '').trim() : '';
                    const desc = cellD ? String(cellD.v || '').trim() : '';
                    const expenseVal = cellE ? (parseFloat(String(cellE.v).replace(',', '.')) || 0) : 0;
                    const incomeVal = cellF ? (parseFloat(String(cellF.v).replace(',', '.')) || 0) : 0;

                    // Skip header rows and empty rows
                    if (!rawDate || (!expenseVal && !incomeVal)) {
                        skippedNoAmount++;
                        continue;
                    }
                    
                    // Parsiranje datuma - SAMO string format DD.MM.YYYY
                    let dateStr = '';
                    
                    if (typeof rawDate === 'string') {
                        const trimmed = rawDate.trim();
                        // Provjeri DD.MM.YYYY format
                        if (trimmed.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
                            dateStr = trimmed;
                            console.log(`‚úÖ Red ${rowNum}: datum = "${dateStr}" (OK)`);
                        } else {
                            console.log(`‚ö†Ô∏è Red ${rowNum}: krivi format datuma = "${trimmed}"`);
                            skippedBadDate++;
                            continue;
                        }
                    } else if (typeof rawDate === 'number') {
                        // Excel serial date - konvertuj
                        dateStr = excelDateToString(rawDate);
                        console.log(`üî¢ Red ${rowNum}: serial ${rawDate} ‚Üí "${dateStr}"`);
                    } else {
                        console.log(`‚ùå Red ${rowNum}: neprepoznat tip datuma =`, rawDate, typeof rawDate);
                        skippedBadDate++;
                        continue;
                    }
                    
                    if (!dateStr || !dateStr.match(/\d{1,2}\.\d{1,2}\.\d{4}/)) {
                        console.log(`‚ùå Red ${rowNum}: finalna provjera nije pro≈°la, dateStr = "${dateStr}"`);
                        skippedBadDate++;
                        continue;
                    }

                    const amount = incomeVal > 0 ? incomeVal : -expenseVal;
                    const type = incomeVal > 0 ? 'income' : 'expense';
                    const fullDesc = [user, desc].filter(Boolean).join(' - ');
                    const month = dateToMonth(dateStr);

                    // Check duplicate: same date + same description + same amount
                    const isDuplicate = transactions.some(t =>
                        t.date === dateStr &&
                        t.description === fullDesc &&
                        Math.abs(t.amount - amount) < 0.01
                    );

                    if (isDuplicate) {
                        skippedDuplicates.push(dateStr);
                        continue;
                    }

                    // Privremeni ID samo za UI - NE ≈°alje se u bazu
                    newTransactions.push({
                        tempId: `temp-${Date.now()}-${rowNum}`,
                        date: dateStr,
                        month: month,
                        description: fullDesc,
                        user: user,
                        type: type,
                        category: '',
                        amount: amount,
                        source: 'xls',
                        club_name: null
                    });
                }

                console.log('üìä STATISTIKA PARSIRANJA:');
                console.log(`   Total redova u CSV-u: ${range.e.r + 1}`);
                console.log(`   ‚úÖ Nove transakcije: ${newTransactions.length}`);
                console.log(`   ‚è≠Ô∏è Duplikati preskoƒçeni: ${skippedDuplicates.length}`);
                console.log(`   ‚ùå Preskoƒçeno - nema cellA: ${skippedNoCellA}`);
                console.log(`   ‚ùå Preskoƒçeno - nema iznosa: ${skippedNoAmount}`);
                console.log(`   ‚ùå Preskoƒçeno - lo≈° datum: ${skippedBadDate}`);
                console.log(`   üìù Total preskoƒçeno: ${skippedNoCellA + skippedNoAmount + skippedBadDate + skippedDuplicates.length}`);
                console.log(`   ‚úîÔ∏è Provjera: ${newTransactions.length} + ${skippedNoCellA + skippedNoAmount + skippedBadDate + skippedDuplicates.length} = ${newTransactions.length + skippedNoCellA + skippedNoAmount + skippedBadDate + skippedDuplicates.length} od ${range.e.r + 1}`);

                if (newTransactions.length === 0) {
                    progress.classList.add('hidden');
                    alert(`Nema novih transakcija!\n\n${skippedDuplicates.length} transakcija je veƒá u sustavu.`);
                    e.target.value = '';
                    return;
                }

                console.log('ü§ñ Pokreƒáem AI kategorizaciju...');
                // AI kategorization
                progressText.textContent = `AI kategorizacija ${newTransactions.length} transakcija...`;

                for (let i = 0; i < newTransactions.length; i++) {
                    const trans = newTransactions[i];
                    progressText.textContent = `AI kategorizacija ${i+1}/${newTransactions.length}: ${trans.description.substring(0,30)}...`;
                    const categories = trans.type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
                    try {
                        const response = await fetch("https://api.anthropic.com/v1/messages", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 100,
                                messages: [{
                                    role: "user",
                                    content: `Kategoriziraj bankovnu transakciju Rotary Distrikta. Vrati SAMO broj kategorije (1-${categories.length}).\n\nTransakcija: ${trans.description}\nIznos: ${Math.abs(trans.amount)} EUR\nTip: ${trans.type === 'income' ? 'Prihod' : 'Tro≈°ak'}\n\nKategorije:\n${categories.map((c, i) => `${i+1}. ${c}`).join('\n')}`
                                }]
                            })
                        });
                        const data = await response.json();
                        const idx = parseInt(data.content[0].text.trim()) - 1;
                        trans.category = categories[Math.max(0, Math.min(idx, categories.length-1))] || categories[0];
                    } catch {
                        trans.category = categories[0];
                    }
                }

                pendingUploadTransactions = newTransactions;

                // Show preview table
                const tbody = document.getElementById('upload-preview-tbody');
                tbody.innerHTML = '';
                newTransactions.forEach((t, idx) => {
                    const categories = t.type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50 ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}">
                            <td class="px-4 py-2 text-sm">${t.date}<br><span class="text-xs text-gray-500">${t.month}</span></td>
                            <td class="px-4 py-2 text-sm max-w-24 truncate">${t.user || '‚Äî'}</td>
                            <td class="px-4 py-2 text-sm max-w-32 truncate" title="${t.description}">${t.description}</td>
                            <td class="px-4 py-2 text-right font-medium ${t.type === 'income' ? 'text-green-700' : 'text-red-700'}">
                                ${t.type === 'income' ? '+' : '-'}‚Ç¨${Math.abs(t.amount).toLocaleString('hr-HR', {minimumFractionDigits:2})}
                            </td>
                            <td class="px-4 py-2 text-center">
                                <select data-idx="${idx}" class="pending-type-select border rounded px-1 py-1 text-xs">
                                    <option value="income" ${t.type === 'income' ? 'selected' : ''}>üìà Prihod</option>
                                    <option value="expense" ${t.type === 'expense' ? 'selected' : ''}>üìâ Tro≈°ak</option>
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <select data-idx="${idx}" class="pending-cat-select border rounded px-1 py-1 text-xs w-full">
                                    <option value="">Odaberi...</option>
                                    ${categories.map(c => `<option value="${c}" ${c === t.category ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 text-center">
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Nova</span>
                            </td>
                        </tr>
                    `;
                });

                // Event listeners for type change - update category options
                document.querySelectorAll('.pending-type-select').forEach(sel => {
                    sel.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        pendingUploadTransactions[idx].type = e.target.value;
                        const catSel = document.querySelector(`.pending-cat-select[data-idx="${idx}"]`);
                        const cats = e.target.value === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
                        catSel.innerHTML = '<option value="">Odaberi...</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                    });
                });

                document.querySelectorAll('.pending-cat-select').forEach(sel => {
                    sel.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        pendingUploadTransactions[idx].category = e.target.value;
                    });
                });

                document.getElementById('upload-summary').textContent =
                    `‚úÖ Pronaƒëeno ${newTransactions.length} novih transakcija | ‚è≠Ô∏è Preskoƒçeno ${skippedDuplicates.length} duplikata. Pregledan i potvrdi kategorije, zatim klikni "Spremi transakcije".`;

                progress.classList.add('hidden');
                results.classList.remove('hidden');

            } catch (err) {
                progress.classList.add('hidden');
                console.error('‚ùå Upload error - full object:', err);
                console.error('‚ùå Error type:', typeof err);
                console.error('‚ùå Error message:', err?.message);
                console.error('‚ùå Error stack:', err?.stack);
                alert('Gre≈°ka pri ƒçitanju datoteke: ' + (err?.message || String(err) || 'Nepoznata gre≈°ka'));
            }

            e.target.value = ''; // Reset file input
        });

        // ==========================================
        // FIX 2: CONFIRM UPLOAD - bez id-a, koristimo returned data
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            const confirmBtn = document.getElementById('confirm-upload-btn');
            if (confirmBtn) confirmBtn.addEventListener('click', async () => {
                if (pendingUploadTransactions.length === 0) return;

                showLoading(true);

                // NE ≈°aljemo id - Supabase ƒáe auto-generirati UUID
                const insertRows = pendingUploadTransactions.map(t => ({
                    date: t.date,
                    description: t.description,
                    type: t.type,
                    category: t.category || '',
                    amount: t.amount,
                    source: 'xls',
                    club_name: t.club_name || null
                }));
                
                console.log('üíæ Spremam u bazu (prvi red):', insertRows[0]);

                const { data: inserted, error } = await sb.from('transactions').insert(insertRows).select();
                if (error) {
                    showLoading(false);
                    alert('Gre≈°ka pri spremanju: ' + error.message);
                    return;
                }
                
                console.log('‚úÖ Supabase vratio (prvi red):', inserted[0]);

                // Koristimo podatke koje je vratio Supabase (s pravim UUID-ovima)
                const savedTransactions = inserted.map(t => ({
                    id: t.id,
                    date: t.date,
                    description: t.description || '',
                    type: t.type,
                    category: t.category || '',
                    amount: parseFloat(t.amount),
                    source: t.source || 'xls',
                    club_name: t.club_name || null
                }));

                transactions = [...savedTransactions, ...transactions];
                pendingUploadTransactions = [];

                document.getElementById('upload-results').classList.add('hidden');
                showLoading(false);

                renderTransactions();

                renderDashboard();

                alert(`‚úÖ Uspje≈°no spremljeno ${insertRows.length} transakcija!`);
                // Switch to transactions tab
                document.querySelector('[data-tab="transactions"]').click();
            });

            const cancelBtn = document.getElementById('cancel-upload-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => {
                pendingUploadTransactions = [];
                document.getElementById('upload-results').classList.add('hidden');
            });
        });

        // Render Dashboard
        function renderDashboard() {
            const incomeActual = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const expenseActual = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const incomeBudget = Object.values(budgetData.income).reduce((sum, v) => sum + v, 0);
            const expenseBudget = Object.values(budgetData.expenses).reduce((sum, v) => sum + v, 0);

            document.getElementById('income-budget-total').textContent = `‚Ç¨${incomeBudget.toLocaleString()}`;
            document.getElementById('income-actual-total').textContent = `‚Ç¨${incomeActual.toLocaleString()}`;
            document.getElementById('expense-budget-total').textContent = `‚Ç¨${expenseBudget.toLocaleString()}`;
            document.getElementById('expense-actual-total').textContent = `‚Ç¨${expenseActual.toLocaleString()}`;

            // Comparison Chart
            if (charts.comparison) charts.comparison.destroy();
            const compCtx = document.getElementById('comparison-chart').getContext('2d');
            charts.comparison = new Chart(compCtx, {
                type: 'bar',
                data: {
                    labels: ['Prihodi', 'Rashodi'],
                    datasets: [{
                        label: 'Bud≈æet',
                        data: [incomeBudget, expenseBudget],
                        backgroundColor: '#005DAA'
                    }, {
                        label: 'Realizirano',
                        data: [incomeActual, expenseActual],
                        backgroundColor: '#F7A81B'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Income Pie
            const incomeByCategory = {};
            transactions.filter(t => t.type === 'income' && t.category).forEach(t => {
                incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + Math.abs(t.amount);
            });

            if (charts.incomePie) charts.incomePie.destroy();
            const incomeCtx = document.getElementById('income-pie-chart').getContext('2d');
            charts.incomePie = new Chart(incomeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(incomeByCategory),
                    datasets: [{
                        data: Object.values(incomeByCategory),
                        backgroundColor: ['#F7A81B', '#005DAA', '#00A651', '#E31C79', '#8884D8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 11 } }
                        }
                    }
                }
            });

            // Expense Pie
            const expenseByCategory = {};
            transactions.filter(t => t.type === 'expense' && t.category).forEach(t => {
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Math.abs(t.amount);
            });

            if (charts.expensePie) charts.expensePie.destroy();
            const expenseCtx = document.getElementById('expense-pie-chart').getContext('2d');
            charts.expensePie = new Chart(expenseCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(expenseByCategory),
                    datasets: [{
                        data: Object.values(expenseByCategory),
                        backgroundColor: ['#F7A81B', '#005DAA', '#00A651', '#E31C79', '#8884D8', '#82CA9D', '#FFC658', '#FF6B9D', '#C084FC', '#FB923C']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 11 } }
                        }
                    }
                }
            });

            renderMonthlyBreakdown();
        }

        // Render Monthly Breakdown
        function renderMonthlyBreakdown() {
            const months = ['06', '07', '08', '09', '10', '11', '12', '01', '02', '03', '04', '05'];
            const monthNames = ['LIP', 'SRP', 'KOL', 'RUJ', 'LIS', 'STU', 'PRO', 'SIJ', 'VEL', 'O≈ΩU', 'TRA', 'SVI'];
            
            const monthlyData = {};
            [...INCOME_CATEGORIES, ...EXPENSE_CATEGORIES].forEach(cat => {
                monthlyData[cat] = months.map(() => 0);
            });

            transactions.forEach(trans => {
                if (!trans.category) return;
                const dateParts = trans.date.split('.');
                if (dateParts.length < 2) return;
                const month = dateParts[1];
                const monthIndex = months.indexOf(month);
                if (monthIndex >= 0 && monthlyData[trans.category]) {
                    monthlyData[trans.category][monthIndex] += Math.abs(trans.amount);
                }
            });

            const tbody = document.getElementById('monthly-breakdown-body');
            tbody.innerHTML = '';

            const incomeCumulative = months.map((m, idx) => INCOME_CATEGORIES.reduce((sum, cat) => sum + monthlyData[cat][idx], 0));
            const incomeCumulativeRunning = [];
            let incomeRunningTotal = 0;
            incomeCumulative.forEach(val => { incomeRunningTotal += val; incomeCumulativeRunning.push(incomeRunningTotal); });

            tbody.innerHTML += `
                <tr class="bg-gradient-to-r from-green-100 to-green-50 font-bold border-b-2 border-green-300">
                    <td class="px-4 py-3 text-sm sticky left-0 bg-green-100">UKUPNO PRIHODI (Kumulativ)</td>
                    <td class="px-4 py-3 text-right"><div class="text-lg font-bold text-green-800">‚Ç¨${incomeRunningTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</div></td>
                    ${incomeCumulativeRunning.map(val => `<td class="px-4 py-3 text-right"><div class="font-bold text-green-700">${val > 0 ? '‚Ç¨' + val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‚Äî'}</div></td>`).join('')}
                </tr>
            `;

            tbody.innerHTML += '<tr class="bg-green-50"><td colspan="14" class="px-5 py-3 font-semibold text-green-900 sticky left-0 bg-green-50">PRIHODI</td></tr>';
            INCOME_CATEGORIES.forEach(cat => {
                const budget = budgetData.income[cat] || 0;
                const monthlyBudget = budget / 12;
                const yearTotal = monthlyData[cat].reduce((sum, val) => sum + val, 0);
                const yearPercent = budget > 0 ? (yearTotal / budget * 100) : 0;
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-3 text-sm sticky left-0 bg-white">${cat}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="font-bold text-green-700">‚Ç¨${yearTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div class="text-xs text-gray-500">Bud≈æet: ‚Ç¨${budget.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div class="text-xs font-semibold ${yearPercent >= 100 ? 'text-green-600' : yearPercent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${yearPercent.toFixed(1)}%</div>
                        </td>
                        ${monthlyData[cat].map((val, idx) => {
                            const percent = monthlyBudget > 0 ? (val / monthlyBudget * 100) : 0;
                            return `<td class="px-4 py-3 text-right">
                                <div class="font-semibold">${val > 0 ? '‚Ç¨' + val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‚Äî'}</div>
                                ${val > 0 ? `<div class="text-xs text-gray-500">‚Ç¨${monthlyBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}</div><div class="text-xs font-semibold ${percent >= 100 ? 'text-green-600' : percent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${percent.toFixed(0)}%</div>` : ''}
                            </td>`;
                        }).join('')}
                    </tr>
                `;
            });

            const expenseCumulative = months.map((m, idx) => EXPENSE_CATEGORIES.reduce((sum, cat) => sum + monthlyData[cat][idx], 0));
            const expenseCumulativeRunning = [];
            let expenseRunningTotal = 0;
            expenseCumulative.forEach(val => { expenseRunningTotal += val; expenseCumulativeRunning.push(expenseRunningTotal); });

            tbody.innerHTML += `
                <tr class="bg-gradient-to-r from-red-100 to-red-50 font-bold border-b-2 border-red-300">
                    <td class="px-4 py-3 text-sm sticky left-0 bg-red-100">UKUPNO RASHODI (Kumulativ)</td>
                    <td class="px-4 py-3 text-right"><div class="text-lg font-bold text-red-800">‚Ç¨${expenseRunningTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</div></td>
                    ${expenseCumulativeRunning.map(val => `<td class="px-4 py-3 text-right"><div class="font-bold text-red-700">${val > 0 ? '‚Ç¨' + val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‚Äî'}</div></td>`).join('')}
                </tr>
            `;

            tbody.innerHTML += '<tr class="bg-red-50"><td colspan="14" class="px-5 py-3 font-semibold text-red-900 sticky left-0 bg-red-50">RASHODI</td></tr>';
            EXPENSE_CATEGORIES.forEach(cat => {
                const budget = budgetData.expenses[cat] || 0;
                const monthlyBudget = budget / 12;
                const yearTotal = monthlyData[cat].reduce((sum, val) => sum + val, 0);
                const yearPercent = budget > 0 ? (yearTotal / budget * 100) : 0;
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-3 text-sm sticky left-0 bg-white">${cat}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="font-bold text-red-700">‚Ç¨${yearTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div class="text-xs text-gray-500">Bud≈æet: ‚Ç¨${budget.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div class="text-xs font-semibold ${yearPercent >= 100 ? 'text-red-600' : yearPercent >= 50 ? 'text-yellow-600' : 'text-green-600'}">${yearPercent.toFixed(1)}%</div>
                        </td>
                        ${monthlyData[cat].map((val, idx) => {
                            const percent = monthlyBudget > 0 ? (val / monthlyBudget * 100) : 0;
                            return `<td class="px-4 py-3 text-right">
                                <div class="font-semibold">${val > 0 ? '‚Ç¨' + val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‚Äî'}</div>
                                ${val > 0 ? `<div class="text-xs text-gray-500">‚Ç¨${monthlyBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}</div><div class="text-xs font-semibold ${percent >= 100 ? 'text-red-600' : percent >= 50 ? 'text-yellow-600' : 'text-green-600'}">${percent.toFixed(0)}%</div>` : ''}
                            </td>`;
                        }).join('')}
                    </tr>
                `;
            });

            const saldoCumulative = incomeCumulativeRunning.map((inc, idx) => inc - expenseCumulativeRunning[idx]);
            const finalSaldo = incomeRunningTotal - expenseRunningTotal;
            tbody.innerHTML += `
                <tr class="bg-gradient-to-r from-blue-100 to-blue-50 font-bold border-t-4 border-blue-400">
                    <td class="px-4 py-4 text-sm sticky left-0 bg-blue-100">SALDO (Kumulativ)</td>
                    <td class="px-4 py-4 text-right"><div class="text-xl font-bold ${finalSaldo >= 0 ? 'text-green-700' : 'text-red-700'}">‚Ç¨${finalSaldo.toLocaleString(undefined, {maximumFractionDigits: 0})}</div></td>
                    ${saldoCumulative.map(val => `<td class="px-4 py-4 text-right"><div class="font-bold ${val >= 0 ? 'text-green-700' : 'text-red-700'}">${val !== 0 ? '‚Ç¨' + val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‚Äî'}</div></td>`).join('')}
                </tr>
            `;
        }

        // Render Transactions
        // Helper: iz datuma DD.MM.YYYY izvuci "MM/YYYY"
        function dateToPeriod(dateStr) {
            if (!dateStr) return '‚Äî';
            const parts = dateStr.split('.');
            if (parts.length < 3) return '‚Äî';
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            const result = `${month}/${year}`;
            console.log('üìÜ dateToPeriod:', dateStr, '‚Üí parts:', parts, '‚Üí result:', result);
            return result;
        }

        // Log promjena na transakcijama
        let transactionChanges = [];

        function renderTransactionsLog() {
            const container = document.getElementById('transactions-activity-log');
            if (!container) return;
            if (transactionChanges.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-8">Jo≈° nema promjena...</p>';
                return;
            }
            container.innerHTML = transactionChanges.map(ch => `
                <div class="mb-3 p-3 bg-white rounded-lg border-l-4 ${ch.field === 'category' ? 'border-blue-400' : 'border-yellow-400'} shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${ch.description}</p>
                            <p class="text-xs text-gray-600 mt-1">
                                <span class="line-through text-gray-400">${ch.oldValue || '‚Äî'}</span>
                                ‚Üí <span class="font-semibold text-rotary-blue">${ch.newValue}</span>
                            </p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">
                            ${ch.field === 'category' ? 'üè∑Ô∏è Kategorija' : 'üìÖ Datum'}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        <span class="font-medium">${ch.user}</span> ‚Ä¢ ${ch.timestamp}
                    </div>
                </div>
            `).join('');
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactions-table-body');
            tbody.innerHTML = '';
            document.getElementById('transaction-count').textContent = transactions.length;

            const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.role === 'editor');

            // Prika≈æi gumb za spremanje samo ako mo≈æe editirati
            const saveBtn = document.getElementById('save-transactions-btn');
            const deleteAllBtn = document.getElementById('delete-all-transactions-btn');
            
            if (saveBtn) {
                if (canEdit) saveBtn.classList.remove('hidden');
                else saveBtn.classList.add('hidden');
            }
            
            if (deleteAllBtn) {
                if (canEdit) deleteAllBtn.classList.remove('hidden');
                else deleteAllBtn.classList.add('hidden');
                
                // Dodaj event listener za brisanje svih transakcija
                const newDeleteAllBtn = deleteAllBtn.cloneNode(true);
                deleteAllBtn.parentNode.replaceChild(newDeleteAllBtn, deleteAllBtn);
                
                newDeleteAllBtn.addEventListener('click', async () => {
                    const count = transactions.length;
                    
                    if (count === 0) {
                        alert('Nema transakcija za brisanje.');
                        return;
                    }
                    
                    // DOUBLE CONFIRM
                    const confirm1 = confirm(`‚ö†Ô∏è UPOZORENJE!\n\nOvo ƒáe obrisati SVE transakcije (${count} komada).\n\nOva akcija se NE MO≈ΩE poni≈°titi!\n\n≈Ωeli≈° li nastaviti?`);
                    if (!confirm1) return;
                    
                    const confirm2 = confirm(`‚ö†Ô∏è POSLJEDNJE UPOZORENJE!\n\nSpreman si obrisati ${count} transakcija.\n\nJesi li APSOLUTNO SIGURAN?\n\nKlikni OK za TRAJNO BRISANJE ili Cancel za odustajanje.`);
                    if (!confirm2) return;
                    
                    showLoading(true);
                    
                    // Obri≈°i sve transakcije iz Supabase
                    const { error } = await sb.from('transactions').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    
                    if (error) {
                        showLoading(false);
                        alert('Gre≈°ka pri brisanju: ' + error.message);
                        return;
                    }
                    
                    // Obri≈°i iz lokalnog stanja
                    transactions = [];
                    
                    // Log aktivnost
                    await sb.from('activity_logs').insert({
                        log_type: 'bulk_delete',
                        description: `Obrisano ${count} transakcija`,
                        old_value: String(count),
                        new_value: '0',
                        user_name: currentUser ? currentUser.name : 'System',
                        user_id: currentUser ? currentUser.id : null
                    });
                    
                    showLoading(false);
                    
                    // Osvje≈æi prikaze
                    renderTransactions();
                    renderDashboard();
                    
                    alert(`‚úÖ Uspje≈°no obrisano ${count} transakcija!`);
                });
            }

            transactions.forEach(trans => {
                const period = dateToPeriod(trans.date);
                const sourceLabel = trans.source === 'xls' || trans.source === 'csv'
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">üìä XLS/CSV</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">‚úçÔ∏è Ruƒçno</span>';

                // Dropdown za klub - samo za prihode
                const clubNames = Object.keys(clubsData).sort();
                let clubDropdown = '‚Äî';
                if (trans.type === 'income') {
                    if (canEdit) {
                        clubDropdown = `
                            <select data-id="${trans.id}" data-field="club_name" class="trans-edit-input club-select border rounded px-2 py-1 text-xs focus:ring-2 focus:ring-yellow-500 w-full">
                                <option value="">‚Äî</option>
                                ${clubNames.map(club => 
                                    `<option value="${club}" ${club === trans.club_name ? 'selected' : ''}>${club}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else {
                        clubDropdown = trans.club_name || '‚Äî';
                    }
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4 text-sm">
                            ${canEdit ? `
                                <input type="text" value="${trans.date}"
                                       data-id="${trans.id}" data-field="date"
                                       class="trans-edit-input border rounded px-2 py-1 w-28 focus:ring-2 focus:ring-yellow-500 text-sm"
                                       placeholder="DD.MM.YYYY" />
                            ` : trans.date}
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-700">${period}</td>
                        <td class="px-6 py-4 text-sm">${trans.description}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${trans.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${trans.type === 'income' ? 'Prihod' : 'Rashod'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${canEdit ? `
                                <select data-id="${trans.id}" data-field="category" class="trans-edit-input category-select border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-yellow-500">
                                    <option value="">Odaberi...</option>
                                    ${(trans.type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES).map(cat =>
                                        `<option value="${cat}" ${cat === trans.category ? 'selected' : ''}>${cat}</option>`
                                    ).join('')}
                                </select>
                            ` : (trans.category || '‚Äî')}
                        </td>
                        <td class="px-6 py-4 text-sm">${clubDropdown}</td>
                        <td class="px-6 py-4 text-right font-medium ${trans.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ‚Ç¨${Math.abs(trans.amount).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 text-center">${sourceLabel}</td>
                        <td class="px-6 py-4 text-center edit-column">
                            ${canEdit ? `<button onclick="deleteTransaction('${trans.id}')" class="text-red-500 hover:text-red-800 font-bold text-lg leading-none">‚úï</button>` : ''}
                        </td>
                    </tr>
                `;
            });

            // Gumb za spremanje - prikuplja sve promjene i sprema odjednom
            if (saveBtn) {
                // Ukloni stari listener da se ne dupliƒçira
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

                newSaveBtn.addEventListener('click', async () => {
                    // Skupi sve izmijenjene vrijednosti iz inputa/selecta
                    const pendingChanges = [];

                    document.querySelectorAll('.trans-edit-input').forEach(el => {
                        const id = el.dataset.id;
                        const field = el.dataset.field;
                        const trans = transactions.find(t => t.id == id);
                        if (!trans) return;

                        const newVal = el.value.trim();

                        if (field === 'date') {
                            if (newVal && newVal !== trans.date) {
                                const datePattern = /^\d{1,2}\.\d{1,2}\.\d{4}$/;
                                if (!datePattern.test(newVal)) {
                                    alert(`Neispravan format datuma za transakciju: "${trans.description}"\nKoristite: DD.MM.YYYY`);
                                    el.value = trans.date;
                                    return;
                                }
                                pendingChanges.push({ id, field, oldVal: trans.date, newVal, trans });
                            }
                        } else if (field === 'category') {
                            if (newVal !== trans.category) {
                                pendingChanges.push({ id, field, oldVal: trans.category, newVal, trans });
                            }
                        } else if (field === 'club_name') {
                            // Prazan string znaƒçi odabrana je prazna opcija "‚Äî"
                            const normalizedNewVal = newVal === '' ? null : newVal;
                            if (normalizedNewVal !== trans.club_name) {
                                pendingChanges.push({ id, field, oldVal: trans.club_name, newVal: normalizedNewVal, trans });
                            }
                        }
                    });

                    if (pendingChanges.length === 0) {
                        alert('Nema promjena za spremiti.');
                        return;
                    }

                    showLoading(true);

                    for (const ch of pendingChanges) {
                        let updateData = {};
                        if (ch.field === 'date') updateData.date = ch.newVal;
                        else if (ch.field === 'category') updateData.category = ch.newVal;
                        else if (ch.field === 'club_name') updateData.club_name = ch.newVal;

                        const { error } = await sb.from('transactions').update(updateData).eq('id', ch.id);
                        if (error) {
                            showLoading(false);
                            alert('Gre≈°ka pri spremanju: ' + error.message);
                            return;
                        }

                        // A≈æuriraj lokalni objekt
                        if (ch.field === 'date') ch.trans.date = ch.newVal;
                        else if (ch.field === 'category') ch.trans.category = ch.newVal;
                        else if (ch.field === 'club_name') ch.trans.club_name = ch.newVal;

                        // Dodaj u log
                        const fieldLabels = { date: 'Datum', category: 'Kategorija', club_name: 'Klub' };
                        const logEntry = {
                            timestamp: new Date().toLocaleString('hr-HR'),
                            user: currentUser ? currentUser.name : 'System',
                            field: ch.field,
                            description: ch.trans.description.substring(0, 40),
                            oldValue: ch.oldVal || '‚Äî',
                            newValue: ch.newVal || '‚Äî'
                        };
                        transactionChanges.unshift(logEntry);

                        // Spremi u Supabase log
                        await sb.from('activity_logs').insert({
                            log_type: 'transaction_edit',
                            description: `${fieldLabels[ch.field]} promijenjena: ${ch.trans.description.substring(0, 40)}`,
                            old_value: ch.oldVal || '',
                            new_value: ch.newVal || '',
                            user_name: currentUser ? currentUser.name : 'System',
                            user_id: currentUser ? currentUser.id : null
                        });
                    }

                    // Sada preraƒçunaj "Uplaƒáeno ‚Ç¨" za svaki klub na temelju transakcija
                    const clubPayments = {};
                    transactions.forEach(t => {
                        if (t.type === 'income' && t.club_name && clubsData[t.club_name]) {
                            clubPayments[t.club_name] = (clubPayments[t.club_name] || 0) + Math.abs(t.amount);
                        }
                    });

                    // A≈æuriraj clubsData i spremi u Supabase
                    for (const clubName in clubsData) {
                        const newActualPayment = clubPayments[clubName] || 0;
                        if (clubsData[clubName].actualPayment !== newActualPayment) {
                            clubsData[clubName].actualPayment = newActualPayment;
                            await sb.from('clubs').update({ actual_payment: newActualPayment }).eq('name', clubName);
                        }
                    }

                    showLoading(false);

                    // Osvje≈æi sve poglede
                    renderTransactions();

                    renderDashboard();
                    renderTransactionsLog();
                    renderClubs(); // Osvje≈æi prikaz klubova

                    newSaveBtn.textContent = '‚úÖ Spremljeno!';
                    setTimeout(() => { newSaveBtn.textContent = 'üíæ Spremi promjene'; }, 2000);
                });
            }
        }

        async function deleteTransaction(id) {
            if (confirm('Obrisati transakciju?')) {
                await sb.from('transactions').delete().eq('id', id);
                transactions = transactions.filter(t => t.id != id);
                renderTransactions();
                renderDashboard();
            }
        }

        // Render Users
        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            document.getElementById('users-count').textContent = users.length;

            const accessDescriptions = {
                admin: 'Dashboard, Bud≈æet, Upload CSV, Realizirano, Transakcije, Korisnici',
                editor: 'Dashboard, Bud≈æet, Upload CSV, Realizirano, Transakcije',
                viewer: 'Dashboard, Bud≈æet (samo pregled)'
            };

            users.forEach(user => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium">${user.name}</td>
                        <td class="px-6 py-4 text-gray-600">${user.email}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 text-xs rounded-full font-semibold ${
                                user.role === 'admin' ? 'bg-yellow-100 text-yellow-800' :
                                user.role === 'editor' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${user.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-500">${accessDescriptions[user.role]}</td>
                        <td class="px-6 py-4 text-center">
                            ${user.email !== currentUser.email ? 
                                `<button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 font-bold">‚úï</button>` : 
                                `<span class="text-gray-400 text-xs">Trenutni korisnik</span>`}
                        </td>
                    </tr>
                `;
            });
        }

        async function deleteUser(userId) {
            if (confirm('Obrisati korisnika?')) {
                await sb.from('users').delete().eq('id', userId);
                users = users.filter(u => u.id !== userId);
                renderUsers();
            }
        }

        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('user-modal').classList.remove('hidden');
        });

        document.getElementById('cancel-user-btn').addEventListener('click', () => {
            document.getElementById('user-modal').classList.add('hidden');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const roleSelect = document.getElementById('new-user-role');
            const roleDescription = document.getElementById('role-description');
            if (roleSelect) roleSelect.addEventListener('change', (e) => {
                const descriptions = {
                    viewer: 'Viewer mo≈æe samo pregledavati Dashboard i Bud≈æet bez moguƒánosti ureƒëivanja.',
                    editor: 'Editor mo≈æe ureƒëivati bud≈æet, uploadati CSV datoteke i kategorizirati transakcije.',
                    admin: 'Admin ima puni pristup svim funkcijama ukljuƒçujuƒái upravljanje korisnicima.'
                };
                if (roleDescription) roleDescription.textContent = descriptions[e.target.value];
            });
        });

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUser = {
                name: document.getElementById('new-user-name').value,
                email: document.getElementById('new-user-email').value,
                password_hash: document.getElementById('new-user-password').value,
                role: document.getElementById('new-user-role').value
            };
            showLoading(true);
            const { data, error } = await sb.from('users').insert(newUser).select().single();
            if (data) {
                users.push(data);
                renderUsers();
            }
            showLoading(false);
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('add-user-form').reset();
        });

        // Export Data to CSV
        document.addEventListener('DOMContentLoaded', () => {
            const exportBtn = document.getElementById('export-data-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    let csvContent = '';
                    csvContent += 'ROTARY DISTRICT 1913 - IZVOZ PODATAKA\n';
                    csvContent += `Datum izvoza: ${new Date().toLocaleString('hr-HR')}\n`;
                    csvContent += `Korisnik: ${currentUser ? currentUser.name : 'N/A'}\n\n`;
                    csvContent += 'BUDZET - PREGLED\nKategorija,Tip,Bud≈æet (EUR),Realizirano (EUR),Razlika (EUR)\n';
                    
                    const incomeByCategory = {};
                    transactions.filter(t => t.type === 'income' && t.category).forEach(t => {
                        incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + Math.abs(t.amount);
                    });
                    INCOME_CATEGORIES.forEach(cat => {
                        const budget = budgetData.income[cat] || 0;
                        const actual = incomeByCategory[cat] || 0;
                        csvContent += `${cat},Prihod,${budget},${actual},${actual - budget}\n`;
                    });
                    
                    const expenseByCategory = {};
                    transactions.filter(t => t.type === 'expense' && t.category).forEach(t => {
                        expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + Math.abs(t.amount);
                    });
                    EXPENSE_CATEGORIES.forEach(cat => {
                        const budget = budgetData.expenses[cat] || 0;
                        const actual = expenseByCategory[cat] || 0;
                        csvContent += `${cat},Rashod,${budget},${actual},${budget - actual}\n`;
                    });
                    
                    const incomeActual = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const expenseActual = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    const incomeBudget = Object.values(budgetData.income).reduce((sum, v) => sum + v, 0);
                    const expenseBudget = Object.values(budgetData.expenses).reduce((sum, v) => sum + v, 0);
                    
                    csvContent += `\nUKUPNO\nTip,Bud≈æet (EUR),Realizirano (EUR)\n`;
                    csvContent += `Prihodi,${incomeBudget},${incomeActual}\nRashodi,${expenseBudget},${expenseActual}\nSaldo,${incomeBudget - expenseBudget},${incomeActual - expenseActual}\n\n`;
                    csvContent += 'SVE TRANSAKCIJE\nDatum,Opis,Tip,Kategorija,Iznos (EUR)\n';
                    transactions.forEach(trans => {
                        const escapedDesc = trans.description.replace(/"/g, '""');
                        csvContent += `${trans.date},"${escapedDesc}",${trans.type === 'income' ? 'Prihod' : 'Rashod'},${trans.category || 'Nekategorizirano'},${trans.amount}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.setAttribute('href', URL.createObjectURL(blob));
                    link.setAttribute('download', `Rotary_D1913_Export_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert('Podaci su uspje≈°no exportani!');
                });
            }
        });

        // ===== PRIHOD PO KLUBU FUNCTIONS =====
        function loadClubsData() {}

        function logPrihodActivity(type, item, field, oldVal, newVal) {
            const ts = new Date().toLocaleString('hr-HR');
            const user = currentUser ? currentUser.name : 'Admin';
            let desc = '';
            
            if (type === 'club') {
                const fields = {rotaryMembers: 'Rotary ƒçlanovi', spouses: 'Supru≈ænici', rotaractMembers: 'Rotaract', actualPayment: 'Uplaƒáeno'};
                desc = `${item} - ${fields[field]}`;
            } else if (type === 'other') {
                desc = `${item} - ${field === 'planned' ? 'Planirano' : 'Realizirano'}`;
            } else if (type === 'club-added') {
                const entry = {timestamp: ts, user, type, description: `Dodan klub: ${item}`, action: 'Dodano'};
                prihodiLog.unshift(entry);
                sb.from('activity_logs').insert({ log_type: 'club_added', description: entry.description, user_name: user, user_id: currentUser?.id || null });
                return;
            } else if (type === 'club-deleted') {
                const entry = {timestamp: ts, user, type, description: `Obrisan klub: ${item}`, action: 'Obrisano'};
                prihodiLog.unshift(entry);
                sb.from('activity_logs').insert({ log_type: 'club_deleted', description: entry.description, user_name: user, user_id: currentUser?.id || null });
                return;
            }
            
            const entry = {
                timestamp: ts, user, type, description: desc,
                oldValue: `‚Ç¨${oldVal.toLocaleString()}`,
                newValue: `‚Ç¨${newVal.toLocaleString()}`
            };
            prihodiLog.unshift(entry);
            sb.from('activity_logs').insert({ log_type: 'club_change', description: desc, old_value: entry.oldValue, new_value: entry.newValue, user_name: user, user_id: currentUser?.id || null });
            renderPrihodiLog();
        }

        function renderPrihodiLog() {
            const c = document.getElementById('prihodi-activity-log');
            if (!c) return;
            if (prihodiLog.length === 0) {
                c.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-8">Jo≈° nema zabilje≈æenih promjena...</p>';
                return;
            }
            c.innerHTML = prihodiLog.map(log => {
                const logType = log.type || log.log_type || '';
                return `
                <div class="mb-3 p-4 bg-white rounded-lg border-l-4 ${
                    logType === 'club' || logType === 'club_change' ? 'border-blue-500' : 
                    logType === 'other' || logType === 'income_change' ? 'border-green-500' :
                    logType === 'club-added' || logType === 'club_added' ? 'border-purple-500' : 'border-red-500'
                } shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${log.description}</p>
                            ${log.oldValue ? `<p class="text-sm text-gray-600 mt-1">${log.oldValue} ‚Üí ${log.newValue}</p>` : ''}
                        </div>
                        <span class="text-xs px-2 py-1 rounded ${
                            logType === 'club' || logType === 'club_change' ? 'bg-blue-100 text-blue-800' :
                            logType === 'other' || logType === 'income_change' ? 'bg-green-100 text-green-800' :
                            logType === 'club-added' || logType === 'club_added' ? 'bg-purple-100 text-purple-800' : 'bg-red-100 text-red-800'
                        }">
                            ${logType.includes('club') && !logType.includes('deleted') ? 'üë• Klub' : 
                              logType.includes('income') || logType === 'other' ? 'üí∞ Prihod' : 
                              logType.includes('added') ? '‚ûï Dodano' : 'üóëÔ∏è Obrisano'}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2"><span class="font-medium">${log.user}</span> ‚Ä¢ ${log.timestamp}</div>
                </div>
            `}).join('');
        }

        function updateMainBudgetFromClubs() {
            let total = 0;
            for (let n in clubsData) {
                const c = clubsData[n];
                total += (c.rotaryMembers * 50) + (c.spouses * 30) + (c.rotaractMembers * 25);
            }
            budgetData.income['Prihodi od ƒçlanarina'] = total;
            budgetData.income['Prihodi od donacija RI za pokriƒáe tro≈°kova DG'] = otherIncomeData['Prihodi od donacija RI za pokriƒáe tro≈°kova DG'].planned;
            budgetData.income['Prihodi od kotizacija za YE, Rotary kamp, RYLA'] = otherIncomeData['Prihodi od kotizacija za YE, Rotary kamp, RYLA'].planned;
            budgetData.income['Prihodi od donacija'] = otherIncomeData['Prihodi od donacija'].planned;
            budgetData.income['Prihodi od kamata na depozite poviƒëenju'] = otherIncomeData['Prihodi od kamata na depozite poviƒëenju'].planned;
            budgetData.income['Ostali prihodi'] = otherIncomeData['Ostali prihodi'].planned;
            budgetData.income['Sredstva iz vi≈°ka sredstava prethodnih godina'] = otherIncomeData['Sredstva iz vi≈°ka sredstava prethodnih godina'].planned;
        }

        function renderClubs() {
            console.log('üè¢ renderClubs called, clubsData:', clubsData);
            const tb = document.getElementById('clubs-tbody');
            if (!tb) {
                console.log('‚ùå clubs-tbody element not found!');
                return;
            }
            tb.innerHTML = '';
            let tR = 0, tS = 0, tRa = 0, tP = 0, tA = 0;
            const names = Object.keys(clubsData).sort();
            console.log('üìã Club names:', names);
            
            if (names.length === 0) {
                tb.innerHTML = '<tr><td colspan="8" class="px-4 py-12 text-center text-gray-500">Nema klubova. Kliknite "+ Dodaj klub"</td></tr>';
                document.getElementById('total-rotary').textContent = '0';
                document.getElementById('total-spouses').textContent = '0';
                document.getElementById('total-rotaract').textContent = '0';
                document.getElementById('total-planned').textContent = '‚Ç¨0';
                document.getElementById('total-actual').textContent = '‚Ç¨0';
                return;
            }

            const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.role === 'editor');
            names.forEach(n => {
                const c = clubsData[n];
                const p = (c.rotaryMembers * 50) + (c.spouses * 30) + (c.rotaractMembers * 25);
                const rem = p - c.actualPayment;
                tR += c.rotaryMembers; tS += c.spouses; tRa += c.rotaractMembers; tP += p; tA += c.actualPayment;
                tb.innerHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">${n}</td>
                    <td class="px-4 py-3 text-center"><input type="number" min="0" value="${c.rotaryMembers}" data-club="${n}" data-f="rotaryMembers" class="ci w-20 px-2 py-1 border rounded text-center" ${!canEdit ? 'disabled' : ''}></td>
                    <td class="px-4 py-3 text-center"><input type="number" min="0" value="${c.spouses}" data-club="${n}" data-f="spouses" class="ci w-20 px-2 py-1 border rounded text-center" ${!canEdit ? 'disabled' : ''}></td>
                    <td class="px-4 py-3 text-center"><input type="number" min="0" value="${c.rotaractMembers}" data-club="${n}" data-f="rotaractMembers" class="ci w-20 px-2 py-1 border rounded text-center" ${!canEdit ? 'disabled' : ''}></td>
                    <td class="px-4 py-3 text-right font-bold text-green-600">‚Ç¨${p.toLocaleString()}</td>
                    <td class="px-4 py-3 text-right"><input type="number" min="0" step="0.01" value="${c.actualPayment}" data-club="${n}" data-f="actualPayment" class="ci w-28 px-2 py-1 border rounded text-right" ${!canEdit ? 'disabled' : ''}></td>
                    <td class="px-4 py-3 text-right font-bold ${rem > 0 ? 'text-orange-600' : 'text-green-600'}">‚Ç¨${rem.toLocaleString()}</td>
                    <td class="px-4 py-3 text-center">${canEdit ? `<button onclick="delClub('${n}')" class="text-red-600 hover:text-red-800 font-bold">‚úï</button>` : ''}</td>
                </tr>`;
            });
            
            document.getElementById('total-rotary').textContent = tR;
            document.getElementById('total-spouses').textContent = tS;
            document.getElementById('total-rotaract').textContent = tRa;
            document.getElementById('total-planned').textContent = '‚Ç¨' + tP.toLocaleString();
            document.getElementById('total-actual').textContent = '‚Ç¨' + tA.toLocaleString();
            
            document.querySelectorAll('.ci').forEach(i => i.addEventListener('change', e => {
                const n = e.target.dataset.club;
                const f = e.target.dataset.f;
                const old = clubsData[n][f];
                const newV = f === 'actualPayment' ? parseFloat(e.target.value) || 0 : parseInt(e.target.value) || 0;
                if (old !== newV) logPrihodActivity('club', n, f, old, newV);
                clubsData[n][f] = newV;
                updateMainBudgetFromClubs();
            }));
        }

        function renderOtherIncome() {
            const c = document.getElementById('other-income');
            if (!c) return;
            c.innerHTML = '';
            const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.role === 'editor');
            for (let cat in otherIncomeData) {
                const d = otherIncomeData[cat];
                const rem = d.planned - d.actual;
                c.innerHTML += `<div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 class="font-bold mb-3 text-rotary-blue">${cat}</h4>
                    <div class="space-y-2">
                        <div><label class="text-xs text-gray-600">Planirano ‚Ç¨</label>
                        <input type="number" min="0" step="0.01" value="${d.planned}" data-cat="${cat}" data-f="planned" class="oi w-full px-3 py-2 border rounded" ${!canEdit ? 'disabled' : ''}></div>
                        <div><label class="text-xs text-gray-600">Realizirano ‚Ç¨</label>
                        <input type="number" min="0" step="0.01" value="${d.actual}" data-cat="${cat}" data-f="actual" class="oi w-full px-3 py-2 border rounded" ${!canEdit ? 'disabled' : ''}></div>
                        <div class="pt-2 border-t"><p class="text-xs text-gray-600">Preostalo</p>
                        <p class="text-lg font-bold ${rem > 0 ? 'text-orange-600' : 'text-green-600'}">‚Ç¨${rem.toLocaleString()}</p></div>
                    </div>
                </div>`;
            }
            document.querySelectorAll('.oi').forEach(i => i.addEventListener('change', e => {
                const cat = e.target.dataset.cat;
                const f = e.target.dataset.f;
                const old = otherIncomeData[cat][f];
                const newV = parseFloat(e.target.value) || 0;
                if (old !== newV) logPrihodActivity('other', cat, f, old, newV);
                otherIncomeData[cat][f] = newV;
                renderOtherIncome();
            }));
        }

        // ==========================================
        // FIX 3: MANUAL ENTRY - bez id-a, koristimo returned data
        // ==========================================
        function loadManualEntryLog() {}

        function renderManualEntryLog() {
            const container = document.getElementById('manual-entry-log');
            if (!container) return;
            if (manualEntryLog.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic text-center py-8">Jo≈° nema ruƒçno unesenih transakcija...</p>';
                return;
            }
            container.innerHTML = manualEntryLog.map(entry => `
                <div class="mb-3 p-4 bg-white rounded-lg border-l-4 ${entry.type === 'income' ? 'border-green-500' : 'border-red-500'} shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${entry.category}</p>
                            <p class="text-sm text-gray-600 mt-1">${entry.description || 'Bez opisa'}</p>
                            <p class="text-lg font-bold ${entry.type === 'income' ? 'text-green-600' : 'text-red-600'} mt-2">‚Ç¨${entry.amount.toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs px-2 py-1 rounded ${entry.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${entry.type === 'income' ? 'üìà Prihod' : 'üìâ Tro≈°ak'}
                            </span>
                            <p class="text-xs text-gray-500 mt-2">${entry.date}</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 pt-2 border-t"><span class="font-medium">${entry.user}</span> ‚Ä¢ ${entry.timestamp}</div>
                </div>
            `).join('');
        }

        function setupManualEntryForm() {
            const form = document.getElementById('manual-entry-form');
            const typeSelect = document.getElementById('manual-type');
            const categorySelect = document.getElementById('manual-category');
            const dateInput = document.getElementById('manual-date');
            
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            if (typeSelect && categorySelect) {
                typeSelect.addEventListener('change', (e) => {
                    categorySelect.innerHTML = '<option value="">Odaberi kategoriju...</option>';
                    const categories = e.target.value === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
                    categories.forEach(cat => {
                        categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                });
            }
            
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const date = document.getElementById('manual-date').value;
                    const type = document.getElementById('manual-type').value;
                    const category = document.getElementById('manual-category').value;
                    const amount = parseFloat(document.getElementById('manual-amount').value);
                    const description = document.getElementById('manual-description').value;
                    
                    if (!date || !type || !category || !amount) {
                        alert('Molimo popunite sva obavezna polja!');
                        return;
                    }
                    
                    const [year, month, day] = date.split('-');
                    const formattedDate = `${day}.${month}.${year}`;
                    
                    // NE ≈°aljemo id - Supabase ƒáe auto-generirati UUID
                    const { data: inserted, error } = await sb.from('transactions').insert({
                        date: formattedDate,
                        description: description || `Ruƒçni unos - ${category}`,
                        type: type,
                        category: category,
                        amount: type === 'income' ? amount : -amount,
                        source: 'manual',
                        club_name: null
                    }).select().single();

                    if (error) {
                        alert('Gre≈°ka pri spremanju: ' + error.message);
                        return;
                    }

                    // Dodaj u lokalnu listu s pravim UUID-om iz Supabase
                    transactions.unshift({
                        id: inserted.id,
                        date: inserted.date,
                        description: inserted.description,
                        type: inserted.type,
                        category: inserted.category,
                        amount: parseFloat(inserted.amount),
                        source: inserted.source,
                        club_name: inserted.club_name || null
                    });

                    // Log entry
                    const logEntry = {
                        timestamp: new Date().toLocaleString('hr-HR'),
                        user: currentUser ? currentUser.name : 'Admin',
                        date: formattedDate,
                        type: type,
                        category: category,
                        amount: amount,
                        description: description || `Ruƒçni unos - ${category}`
                    };

                    await sb.from('activity_logs').insert({
                        log_type: 'manual_entry',
                        description: logEntry.description,
                        old_value: null,
                        new_value: JSON.stringify(logEntry),
                        user_name: currentUser ? currentUser.name : 'System',
                        user_id: currentUser ? currentUser.id : null
                    });

                    manualEntryLog.unshift(logEntry);
                    if (manualEntryLog.length > 100) manualEntryLog = manualEntryLog.slice(0, 100);
                    
                    document.getElementById('manual-amount').value = '';
                    document.getElementById('manual-description').value = '';
                    document.getElementById('manual-category').value = '';
                    
                    renderDashboard();

                    renderTransactions();
                    renderManualEntryLog();
                    
                    alert('‚úÖ Transakcija uspje≈°no dodana!');
                });
            }
        }

        async function delClub(n) {
            if (confirm('Obrisati "' + n + '"?')) {
                await sb.from('clubs').delete().eq('name', n);
                await sb.from('activity_logs').insert({
                    log_type: 'club_deleted',
                    description: `Klub "${n}" obrisan`,
                    user_name: currentUser ? currentUser.name : 'System',
                    user_id: currentUser ? currentUser.id : null
                });
                delete clubsData[n];
                renderClubs();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const addBtn = document.getElementById('add-club-btn');
            if (addBtn) addBtn.addEventListener('click', async () => {
                const n = prompt('Naziv kluba (npr. RC Zagreb, Rotaract Split):');
                if (n && n.trim()) {
                    if (clubsData[n.trim()]) { alert('Klub veƒá postoji!'); return; }
                    clubsData[n.trim()] = { rotaryMembers: 0, spouses: 0, rotaractMembers: 0, actualPayment: 0 };
                    await sb.from('clubs').insert({ name: n.trim(), rotary_members: 0, spouses: 0, rotaract_members: 0, actual_payment: 0 });
                    await sb.from('activity_logs').insert({
                        log_type: 'club_added',
                        description: `Klub "${n.trim()}" dodan`,
                        user_name: currentUser ? currentUser.name : 'System',
                        user_id: currentUser ? currentUser.id : null
                    });
                    
                    // Osvje≈æi log
                    const { data: prihodiRows } = await sb.from('activity_logs').select('*').in('log_type', ['club_change', 'club_added', 'club_deleted', 'income_change']).order('created_at', { ascending: false }).limit(100);
                    if (prihodiRows) {
                        prihodiLog = prihodiRows.map(r => ({
                            timestamp: new Date(r.created_at).toLocaleString('hr-HR'),
                            user: r.user_name || 'System',
                            type: r.log_type,
                            description: r.description,
                            oldValue: r.old_value,
                            newValue: r.new_value
                        }));
                    }
                    
                    renderClubs();
                    renderPrihodiLog();
                }
            });
            
            const saveClubs = document.getElementById('save-clubs');
            if (saveClubs) saveClubs.addEventListener('click', async () => {
                showLoading(true);
                let savedCount = 0;
                for (const [name, c] of Object.entries(clubsData)) {
                    const { error } = await sb.from('clubs').upsert({
                        name: name,
                        rotary_members: c.rotaryMembers,
                        spouses: c.spouses,
                        rotaract_members: c.rotaractMembers,
                        actual_payment: c.actualPayment
                    }, { onConflict: 'name' });
                    if (!error) savedCount++;
                    else console.error('Club save error:', error);
                }
                updateMainBudgetFromClubs();
                await saveData('rotary-budget', budgetData);
                await sb.from('activity_logs').insert({
                    log_type: 'club_change',
                    description: `ƒålanarine a≈æurirane (${savedCount} klubova)`,
                    user_name: currentUser ? currentUser.name : 'System',
                    user_id: currentUser ? currentUser.id : null
                });
                const { data: clubRows, error: clubError } = await sb.from('clubs').select('*');
                if (clubRows && clubRows.length > 0) {
                    clubsData = {};
                    clubRows.forEach(c => {
                        clubsData[c.name] = {
                            rotaryMembers: c.rotary_members || 0,
                            spouses: c.spouses || 0,
                            rotaractMembers: c.rotaract_members || 0,
                            actualPayment: parseFloat(c.actual_payment) || 0
                        };
                    });
                }
                const { data: prihodiRows } = await sb.from('activity_logs').select('*').in('log_type', ['club_change', 'club_added', 'club_deleted', 'income_change']).order('created_at', { ascending: false }).limit(100);
                if (prihodiRows) {
                    prihodiLog = prihodiRows.map(r => ({
                        timestamp: new Date(r.created_at).toLocaleString('hr-HR'),
                        user: r.user_name || 'System',
                        type: r.log_type,
                        description: r.description,
                        oldValue: r.old_value,
                        newValue: r.new_value
                    }));
                }
                showLoading(false);
                renderClubs();
                renderPrihodiLog();
                renderDashboard();
                alert(`‚úÖ ƒålanarine spremljene! (${savedCount} klubova)`);
            });
            
            const saveOther = document.getElementById('save-other');
            if (saveOther) saveOther.addEventListener('click', async () => {
                showLoading(true);
                for (const [category, vals] of Object.entries(otherIncomeData)) {
                    await sb.from('other_income').upsert({
                        category: category,
                        planned: vals.planned,
                        actual: vals.actual
                    }, { onConflict: 'category' });
                }
                updateMainBudgetFromClubs();
                await saveData('rotary-budget', budgetData);
                await sb.from('activity_logs').insert({
                    log_type: 'income_change',
                    description: 'Ostali prihodi a≈æurirani',
                    user_name: currentUser ? currentUser.name : 'System',
                    user_id: currentUser ? currentUser.id : null
                });
                showLoading(false);
                alert('‚úÖ Ostali prihodi spremljeni!');
                renderDashboard();
            });
        });

        console.log('üöÄ Rotary District 1913 Budget Tracker - Supabase Version (Fixed)');
        console.log('üåê Cloud storage:', SUPABASE_URL);
    </script>
</body>
</html>
